# Ruby CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-ruby/ for more details
#
version: 2

references:
  cloud_platform_container_config: &cloud_platform_container_config
    docker:
    - image: ${ECR_ENDPOINT}/cloud-platform/tools:circleci
      environment:
        GITHUB_TEAM_NAME_SLUG: laa-get-paid
        REPO_NAME: cccd

  build_container_config: &build_container_config
    working_directory: ~/repo
    docker:
      - image: circleci/ruby:2.6.5-node-browsers
        environment:
          CBO_BASE_DATABASE_DATABASE: cccd_test
          PGHOST: 127.0.0.1
          PGUSER: postgres
          RAILS_ENV: test
          TZ: Europe/London
          GITHUB_TEAM_NAME_SLUG: laa-get-paid
          REPO_NAME: cccd
      - image: circleci/postgres:9.6-alpine
        environment:
          POSTGRES_USER: postgres
          POSTGRES_DB: cccd_test
          POSTGRES_PASSWORD: ""

  decrypt_secrets: &decrypt_secrets
    run:
      name: Decrypt secrets file
      command: |
        echo "${GIT_CRYPT_KEY}" | base64 -d > git-crypt.key
        git-crypt unlock git-crypt.key

  _restore-cache: &restore-cache
    restore_cache:
      keys:
        - v2-dependencies-{{ checksum "Gemfile.lock" }}
        # fallback to using the latest cache if no exact match is found
        - v2-dependencies-

  _install-dependencies: &install-dependencies
    run:
      name: Install dependencies
      command: |
        bundler_version=$(cat Gemfile.lock | tail -1 | tr -d " ")
        gem install bundler -v $bundler_version
        bundle check || bundle install --jobs=4 --retry=3 --path vendor/bundle

  _save-cache: &save-cache
    save_cache:
      key: v2-dependencies-{{ checksum "Gemfile.lock" }}
      paths:
        - vendor/bundle

  _attach-tmp-workspace: &attach-tmp-workspace
      attach_workspace:
        at: ~/repo/tmp

  _create-tmp-dir: &create-tmp-dir
    run:
      name: Create workspace temporary directories
      command: |
        mkdir -p tmp/
        mkdir -p tmp/coverage/

  _install-codeclimate: &install-codeclimate
    run:
      name: Install Code Climate test-reporter
      command: |
        curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > tmp/cc-test-reporter
        chmod +x tmp/cc-test-reporter

  _persist-codeclimate: &persist-codeclimate
    persist_to_workspace:
      root: tmp
      paths:
        - cc-test-reporter

  _wait-for-db: &wait-for-db
    run:
      name: Wait for DB
      command: dockerize -wait tcp://localhost:5432 -timeout 1m

  _load-db: &load-db
    run:
      name: Database setup
      command: bin/rails db:schema:load --trace

  _rubocop: &rubocop
    run:
      name: Run rubocop
      command: bundle exec rubocop

  _brakeman: &brakeman
    run:
      name: Run brakeman
      command: bundle exec brakeman

  _jasmine: &jasmine
    run:
      name: Run jasmine
      command: bundle exec rake jasmine:ci

  _rspec: &rspec
    run:
      name: Run rspec tests
      command: |
        tmp/cc-test-reporter before-build
        TESTS=$(circleci tests glob "spec/**/*_spec.rb" | circleci tests split)
        bundle exec rspec ${TESTS}
        tmp/cc-test-reporter format-coverage -t simplecov -o "tmp/coverage/codeclimate.$CIRCLE_NODE_INDEX.json"

  _cucumber: &cucumber
    run:
        name: Run cucumber tests
        command: |
          FEATURES=$(circleci tests glob "features/**/*.feature" | circleci tests split)
          bundle exec cucumber ${FEATURES} --format progress --color

  _install-wkhtmltopdf: &install-wkhtmltopdf
    run:
      name: Install wkhtmltopdf
      command: |
        sudo apt-get update && sudo apt-get -y install wkhtmltopdf

  _build-docker-image: &build_docker_image
    run:
      name: Build cccd docker image
      command: |
        docker_registry_tag="${ECR_ENDPOINT}/${GITHUB_TEAM_NAME_SLUG}/${REPO_NAME}:app-${CIRCLE_SHA1}"
        docker build \
          --build-arg VERSION_NUMBER="NOT USED ANYMORE" \
          --build-arg BUILD_DATE=$(date +%Y-%m-%dT%H:%M:%S%z) \
          --build-arg COMMIT_ID=${CIRCLE_SHA1} \
          --build-arg BUILD_TAG="app-${CIRCLE_SHA1}" \
          --build-arg APP_BRANCH=${CIRCLE_BRANCH} \
          --build-arg LIVE1_DB_TASK=migrate \
          --pull \
          --tag $docker_registry_tag \
          --file docker/Dockerfile .

  _push-docker-image: &push_docker_image
    run:
      name: Push cccd docker image
      command: |
        sudo apt-get install -y python3-pip
        sudo pip3 install awscli
        $(aws ecr get-login --region ${AWS_DEFAULT_REGION} --no-include-email)
        docker_registry_tag="${ECR_ENDPOINT}/${GITHUB_TEAM_NAME_SLUG}/${REPO_NAME}:app-${CIRCLE_SHA1}"
        docker push $docker_registry_tag
        if [ "${CIRCLE_BRANCH}" == "master" ]; then
          docker_registry_latest_tag="${ECR_ENDPOINT}/${GITHUB_TEAM_NAME_SLUG}/${REPO_NAME}:app-latest"
          docker tag $docker_registry_tag $docker_registry_latest_tag
          docker push $docker_registry_latest_tag
        fi

  _setup-dev: &setup-dev
    run:
      name: Kubectl deployment setup dev
      command: |
        $(aws ecr get-login --region ${AWS_DEFAULT_REGION} --no-include-email)
        setup-kube-auth
        kubectl config use-context dev

  _apply-dev: &apply-dev
    deploy:
      name: Deploy cccd docker image to cccd-dev
      command: |
        docker_image_tag=${ECR_ENDPOINT}/${GITHUB_TEAM_NAME_SLUG}/${REPO_NAME}:app-${CIRCLE_SHA1}
        kubectl apply -f kubernetes_deploy/dev/secrets.yaml
        kubectl set image -f kubernetes_deploy/dev/deployment.yaml cccd-app=${docker_image_tag} --local -o yaml | kubectl apply -f -
        kubectl apply \
        -f kubernetes_deploy/dev/service.yaml \
        -f kubernetes_deploy/dev/ingress.yaml \
        -f kubernetes_deploy/cron_jobs/archive_stale.yaml
        kubectl annotate deployments/claim-for-crown-court-defence kubernetes.io/change-cause="$(date +%Y-%m-%dT%H:%M:%S%z) - deploying: $docker_image_tag"

  _setup-api-sandbox: &setup-api-sandbox
    run:
      name: Kubectl deployment setup api-sandbox
      command: |
        $(aws ecr get-login --region ${AWS_DEFAULT_REGION} --no-include-email)
        setup-kube-auth
        kubectl config use-context sandbox

  _apply-api-sandbox: &apply-api-sandbox
    deploy:
      name: Deploy cccd docker image to cccd-api-sandbox
      command: |
        docker_image_tag=${ECR_ENDPOINT}/${GITHUB_TEAM_NAME_SLUG}/${REPO_NAME}:app-${CIRCLE_SHA1}
        kubectl apply -f kubernetes_deploy/api-sandbox/secrets.yaml
        kubectl set image -f kubernetes_deploy/api-sandbox/deployment.yaml cccd-app=${docker_image_tag} --local -o yaml | kubectl apply -f -
        kubectl apply \
        -f kubernetes_deploy/api-sandbox/service.yaml \
        -f kubernetes_deploy/api-sandbox/ingress.yaml \
        -f kubernetes_deploy/cron_jobs/archive_stale.yaml
        kubectl annotate deployments/claim-for-crown-court-defence kubernetes.io/change-cause="$(date +%Y-%m-%dT%H:%M:%S%z) - deploying: $docker_image_tag"

  _setup-staging: &setup-staging
    run:
      name: Kubectl deployment setup staging
      command: |
        $(aws ecr get-login --region ${AWS_DEFAULT_REGION} --no-include-email)
        setup-kube-auth
        kubectl config use-context staging

  _apply-staging: &apply-staging
    deploy:
      name: Deploy cccd docker image to cccd-staging
      command: |
        docker_image_tag=${ECR_ENDPOINT}/${GITHUB_TEAM_NAME_SLUG}/${REPO_NAME}:app-${CIRCLE_SHA1}
        kubectl apply -f kubernetes_deploy/staging/secrets.yaml
        kubectl set image -f kubernetes_deploy/staging/deployment.yaml cccd-app=${docker_image_tag} --local -o yaml | kubectl apply -f -
        kubectl apply \
        -f kubernetes_deploy/staging/service.yaml \
        -f kubernetes_deploy/staging/ingress.yaml \
        -f kubernetes_deploy/cron_jobs/archive_stale.yaml
        kubectl annotate deployments/claim-for-crown-court-defence kubernetes.io/change-cause="$(date +%Y-%m-%dT%H:%M:%S%z) - deploying: $docker_image_tag"

  _setup-prod: &setup-prod
    run:
      name: Kubectl deployment setup prod
      command: |
        $(aws ecr get-login --region ${AWS_DEFAULT_REGION} --no-include-email)
        setup-kube-auth
        kubectl config use-context production

  _apply-prod: &apply-prod
    deploy:
      name: Deploy cccd docker image to cccd-prod
      command: |
        docker_image_tag=${ECR_ENDPOINT}/${GITHUB_TEAM_NAME_SLUG}/${REPO_NAME}:app-${CIRCLE_SHA1}
        kubectl apply -f kubernetes_deploy/production/secrets.yaml
        kubectl set image -f kubernetes_deploy/production/deployment.yaml cccd-app=${docker_image_tag} --local -o yaml | kubectl apply -f -
        kubectl apply \
        -f kubernetes_deploy/production/service.yaml \
        -f kubernetes_deploy/production/ingress.yaml \
        -f kubernetes_deploy/cron_jobs/archive_stale.yaml
        kubectl annotate deployments/claim-for-crown-court-defence kubernetes.io/change-cause="$(date +%Y-%m-%dT%H:%M:%S%z) - deploying: $docker_image_tag"

jobs:
  build:
    <<: *build_container_config
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - *create-tmp-dir
      - *install-codeclimate
      - *persist-codeclimate
      - *restore-cache
      - *install-dependencies
      - *save-cache

  rspec-tests:
    <<: *build_container_config
    parallelism: 4
    steps:
      - checkout
      - *restore-cache
      - *install-dependencies
      - *save-cache
      - *install-wkhtmltopdf
      - *wait-for-db
      - *load-db
      - *attach-tmp-workspace
      - *rspec
      - persist_to_workspace:
          root: tmp
          paths:
            - coverage/codeclimate.*.json
      - store_artifacts:
          path: tmp/coverage

  cucumber-tests:
    <<: *build_container_config
    parallelism: 2
    steps:
      - checkout
      - *restore-cache
      - *install-dependencies
      - *save-cache
      - *install-wkhtmltopdf
      - *wait-for-db
      - *load-db
      - *cucumber
      - store_artifacts:
          path: tmp/capybara

  other-tests:
    <<: *build_container_config
    steps:
      - checkout
      - *restore-cache
      - *install-dependencies
      - *save-cache
      - *rubocop
      - *brakeman
      - *jasmine

  upload-coverage:
    <<: *build_container_config
    steps:
      - *attach-tmp-workspace
      - run:
          name: Upload coverage results to Code Climate
          command: |
            tmp/cc-test-reporter sum-coverage --output - --parts 4 tmp/coverage/codeclimate.*.json | tmp/cc-test-reporter upload-coverage --input -

  build-and-push-docker:
    <<: *build_container_config
    steps:
      - checkout
      - setup_remote_docker
      - *build_docker_image
      - *push_docker_image

  deploy-dev:
    <<: *cloud_platform_container_config
    steps:
      - checkout
      - setup_remote_docker
      - *setup-dev
      - *decrypt_secrets
      - *apply-dev

  deploy-api-sandbox:
    <<: *cloud_platform_container_config
    steps:
      - checkout
      - setup_remote_docker
      - *setup-api-sandbox
      - *decrypt_secrets
      - *apply-api-sandbox

  deploy-staging:
    <<: *cloud_platform_container_config
    steps:
      - checkout
      - setup_remote_docker
      - *setup-staging
      - *decrypt_secrets
      - *apply-staging

  deploy-production:
    <<: *cloud_platform_container_config
    steps:
      - checkout
      - setup_remote_docker
      - *setup-prod
      - *decrypt_secrets
      - *apply-prod

  auto-deploy-dev:
    <<: *cloud_platform_container_config
    steps:
      - checkout
      - setup_remote_docker
      - *setup-dev
      - *decrypt_secrets
      - *apply-dev

  # TODO: once merged with new alpine build try this out
  #
  # build-prod-container:
  #   docker:
  #     - image: docker:17.03-git
  #       environment:
  #         DSD_APP_NAME: "advocatedefencepayments"
  #         ECR_APP_NAME: "claim-for-crown-court-defence"
  #         ECR_DOCKER_IMAGE: "laa-get-paid/claim-crown-court-defence"
  #   steps:
  #     - checkout
  #     - setup_remote_docker:
  #         version: 17.03.0-ce
  #         docker_layer_caching: true
  #     - run:
  #         name: Login to the DSD Docker registry
  #         command: |
  #           docker login \
  #             --username $DOCKER_USER \
  #             --password $DOCKER_PASS \
  #             --email $DOCKER_EMAIL \
  #             $DOCKER_REGISTRY
  #     - run:
  #         name: Login to the ECR Docker registry
  #         command: |
  #           apk add --no-cache --no-progress py2-pip
  #           pip install awscli
  #           ecr_login="$(aws ecr get-login --region eu-west-1 --no-include-email)"
  #           ${ecr_login}
  #     - run:
  #         name: Build docker image
  #         command: |
  #           docker build --pull -t $ECR_ENDPOINT/$ECR_APP_NAME -f docker/Dockerfile .
  #           docker tag $ECR_ENDPOINT/$ECR_APP_NAME $ECR_ENDPOINT/$ECR_APP_NAME:$CIRCLE_BUILD_NUM
  #           docker push $ECR_ENDPOINT/$ECR_APP_NAME:$CIRCLE_BUILD_NUM

workflows:
  version: 2
  build-and-test:
    jobs:
      - build
      - other-tests:
          requires:
            - build
      - rspec-tests:
          requires:
            - build
      - cucumber-tests:
          requires:
            - build
      - upload-coverage:
          requires:
            - rspec-tests
            - cucumber-tests
            - other-tests
      - build-and-push-docker:
          requires:
            - upload-coverage
      - auto-deploy-dev:
          requires:
            - build-and-push-docker
          filters:
            branches:
              only:
                - master
      - hold-dev:
          type: approval
          requires:
            - build-and-push-docker
          filters:
            branches:
              ignore:
                - master
      - deploy-dev:
          requires:
            - hold-dev
          filters:
            branches:
              ignore:
                - master
      - hold-api-sandbox:
          type: approval
          requires:
            - build-and-push-docker
      - deploy-api-sandbox:
          requires:
            - hold-api-sandbox
      - hold-staging:
          type: approval
          requires:
            - build-and-push-docker
      - deploy-staging:
          requires:
            - hold-staging
      - hold-production:
          type: approval
          requires:
            - build-and-push-docker
          filters:
            branches:
              only:
                - master
      - deploy-production:
          requires:
            - hold-production
