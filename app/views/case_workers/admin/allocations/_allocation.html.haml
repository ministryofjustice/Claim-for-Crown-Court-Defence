= render partial: 'errors/error_summary', locals:{ ep: @allocation, error_summary: 'This claim allocation has '}

= render partial: 'layouts/header', locals: {page_heading: 'Allocation'}

= form_tag case_workers_admin_allocations_path, method: :get do
  = hidden_field_tag :tab, params[:tab]
  .grid-row
    = render partial: 'scheme_filters'
    = render partial: 'case_type_filters'

= form_for [:case_workers, :admin, @allocation] do |f|
  = hidden_field_tag :tab, params[:tab]
  = hidden_field_tag :scheme, params[:scheme]
  = hidden_field_tag :filter, params[:filter] if params[:filter]
  = hidden_field_tag :page, params[:page]

  .grid-row.js-typeahead
    .form-row.form-group.js-typeahead
      .form-col
        = label_tag :quantity_to_allocate, t('.no_of_claims')
        = number_field_tag :quantity_to_allocate, nil, { style: 'width:100%', min: 0, size: 5, class: 'form-control'}
      .form-col
        = f.label :case_worker_id, t('dictionary.models.case_worker'), {for: "allocation_case_worker_id_autocomplete"}
        = f.collection_select :case_worker_id, @case_workers, :id, :name, { include_blank: ''.html_safe }, { class: 'form-control typeahead' }

      .form-col{ style: 'padding: 26px 0 0' }
        = f.submit 'Allocate', class: 'button'
  - if @claims.any?

    .container.table-container
      %table.report.js-checkbox-table
        %caption
          %span.table-caption
            = 'Allocations'
          %span.claim-count
            = "Number of claims: "
            = @claims.total_count
        %thead
          %th{scope:'col'}
            = link_to 'Select all', '#', class: 'select-all', data: { 'all-checked' => 'false' }
          %th{scope:'col'}
            = t('.case_number')
          %th{scope:'col'}
            = owner_column_header
          %th{scope:'col'}
            = t('.defendants')
          %th{scope:'col'}
            Type
          %th.numeric{scope:'col'}
            = t('.submitted_date')
          %th.numeric{scope:'col'}
            = t('.claim_total')
          - if params[:tab] == 'allocated'
            %th{scope:'col'}
              Allocated to
        %tbody
          = f.collection_check_boxes :claim_ids, @claims, :id, :case_number do |b|
            - present(b.object) do |claim|
              %tr{id: dom_id(claim)}
                %td{'aria-label' => t(".select")}
                  = b.label(class:'visuallyhidden'){"Choose #{claim.case_number}"}
                  = b.check_box
                %td{'aria-label' => t(".case_number")}
                  %span.js-test-case-number
                    = link_to claim.case_number , case_workers_claim_path(claim)
                    %span.unique-id-small= claim.unique_id
                %td{'aria-label' => owner_column_header}
                  = claim.external_user.name
                %td{'aria-label' => t(".defendants")}
                  = claim.defendant_names
                %td{'aria-label' => t(".type")}
                  = claim.case_type_name
                %td.numeric{'aria-label' => t(".submitted_date")}
                  = claim.submitted_at
                %td.numeric{'aria-label' => t(".claim_total")}
                  = claim.total_inc_vat
                - if params[:tab] == 'allocated'
                  %td{'aria-label' => t(".allocated_to")}
                    = claim.case_workers.map(&:name).join(', ')

  - else
    = "No claims need to be allocated."
