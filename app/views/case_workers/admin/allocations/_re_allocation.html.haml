= render partial: 'layouts/header', locals: { page_heading: t('.page_heading') }

.govuk-grid-row
  .govuk-grid-column-full

    .govuk-grid-row
      .govuk-grid-column-two-thirds
        = govuk_error_summary(@allocation, :allocation)

    = form_with url: case_workers_admin_allocations_path, method: :get, builder: GdsAdpFormBuilder do |f|
      = render partial: 'orig_scheme_filters', locals: { f: f }

      = render partial: 'shared/search_form', locals: { search_path: case_workers_admin_allocations_path(anchor: 'search-button'), hint_text: t('hint.search'), button_text: t('search.claims') }

    = form_with model: [:case_workers, :admin, @allocation], builder: GdsAdpFormBuilder do |f|
      = hidden_field_tag :scheme, params[:scheme]
      = hidden_field_tag :page, params[:page]

      .govuk-grid-row
        .govuk-grid-column-two-thirds
          = f.govuk_radio_buttons_fieldset :deallocate, legend: { text: t('.legend'), size: 'm' }, hint: { text: t('.form_hint_html') } do
            = f.govuk_radio_button :deallocate, 'true', label: { text: t('.allocation_pool') }, link_errors: true
            = f.govuk_radio_button :deallocate, 'false', label: { text: t('.case_worker') } do
              #cc-caseworker.fx-autocomplete-wrapper
                = f.govuk_select :case_worker_id, label: { text: t('.case_worker_name') } do
                  = options_for_select [['', '']]
                  = options_from_collection_for_select @case_workers, :id, :name

          = f.govuk_submit t('.re_allocate'), name: 'tab', value: 'allocated'

      - if @claims.any?
        .table-container
          %table.report.js-checkbox-table.js-reallocation-report
            %caption#allocation-claim-ids-field-error
              .govuk-grid-row
                .govuk-grid-column-one-half
                  = t('.re_allocation')
                .govuk-grid-column-one-half.claim-count
                  = t('.number_of_claims')
                  = @claims.total_count

            %thead
              %th.select{ scope: 'col' }
                = govuk_link_to t('.select_all'), '#', class: 'select-all', data: { 'all-checked': 'false' }, 'aria-label': t('.select_all_label')
              %th.case-number{ scope: 'col' }
                = t('.case_number')
              %th.court{ scope: 'col' }
                = t('.court')
              %th{ scope: 'col' }
                = t('.defendants')
              %th.type{ scope: 'col' }
                = t('.type')
              %th.numeric.submit-date{ scope: 'col' }
                = t('.submitted_date')
              %th.numeric.claim-total{ scope: 'col' }
                = t('.claim_total')
              - if params[:tab] == 'allocated'
                %th{ scope: 'col' }
                  = t('.allocated_to')

            %tbody
              = collection_check_boxes :allocation, :claim_ids, @claims, :id, :case_number do |b|
                - present(b.object) do |claim|
                  %tr{ id: dom_id(claim), class: claim.injection_error ? 'error injection-error' : nil }
                    %td{ 'data-label': t('.select') }
                      .govuk-form-group.error-message-container
                        .govuk-checkboxes.govuk-checkboxes--small{ 'data-module': 'govuk-checkboxes' }
                          .govuk-checkboxes__item
                            = b.check_box(class: 'govuk-checkboxes__input')
                            = b.label(class: 'govuk-label govuk-checkboxes__label'){ t('.choose_label_html', case_number: claim.case_number) }

                        - claim.injection_error do |message|
                          .error-message
                            = message

                    %td{ 'data-label': t('.case_number') }
                      %span.js-test-case-number
                        = govuk_link_to claim.case_number, case_workers_claim_path(claim), 'aria-label': t('.case_number_label', case_number: claim.case_number)
                        %span.unique-id-small
                          = claim.unique_id
                        - if claim.disk_evidence == true
                          %span.disk-evidence
                            = t('.disk_evidence')

                    %td{ 'data-label': t('.court') }
                      = claim.court.name

                    %td{ 'data-label': t('.defendants') }
                      = claim.defendant_names

                    %td{ 'data-label': t('.type') }
                      = claim.case_type_name
                      %br/
                      %span.claim-state
                        = claim.claim_state

                    %td.numeric{ 'data-label': t('.submitted_date') }
                      = claim.submitted_at_short

                    %td.numeric{ 'data-label': t('.claim_total') }
                      = claim.total_inc_vat

                    - if params[:tab] == 'allocated'
                      %td{ 'data-label': t('.allocated_to') }
                        = claim.case_workers.map(&:name).join(', ')

      - else
        %p.govuk-body{ class: 'govuk-!-font-weight-bold' }
          = t('.no_claims_allocated')
